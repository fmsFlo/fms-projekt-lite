// VERCEL + SUPABASE POSTGRES SETUP
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Client {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  firstName String
  lastName  String
  email     String?
  phone     String?
  street    String?
  houseNumber String?
  city      String?
  zip       String?
  iban      String?
  crmId     String?
  isCompany Boolean  @default(false)
  companyName String?
  birthDate DateTime?
  profession String?
  employmentStatus String?
  salaryGrade String?
  grvInsuranceStatus String?
  nextCallDate DateTime?
  callNotes    String?
  contracts Contract[]
  opportunities Opportunity[]
  leads         Lead[]
  retirementConcepts RetirementConcept[]
}

model ContractTemplate {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  name        String
  slug        String   @unique
  description String?
  fields      String
  category    String?  @default("Honorar Beratung")
}

model Contract {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  clientId          String
  client            Client   @relation(fields: [clientId], references: [id])
  templateSlug      String
  variables         String
  pdfFileName       String?
  signedPdfFileName String?
  stripeCustomerId String?
  stripeMandateId  String?
  stripeMandateStatus String?
  sevdeskInvoiceId String?
  sevdeskInvoiceNumber String?
}

model Company {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  settings CompanySettings?
}

model CompanySettings {
  id                        String   @id @default(cuid())
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  companyId                 String   @unique
  emailNotifications        Boolean  @default(true)
  smsNotifications          Boolean  @default(false)
  currency                  String   @default("EUR")
  timezone                  String   @default("Europe/Berlin")

  personalName              String?
  personalEmail             String?
  personalStreet            String?
  personalHouseNumber       String?
  personalZip               String?
  personalCity              String?
  personalPhone             String?
  personalWebsite           String?

  companyName               String?
  contactPerson             String?
  companyEmail              String?
  companyStreet             String?
  companyHouseNumber        String?
  companyZip                String?
  companyCity               String?
  companyPhone              String?
  companyWebsite            String?

  billingStreet             String?
  billingHouseNumber        String?
  billingZip                String?
  billingCity               String?
  billingEmail              String?

  makeWebhookUrl            String?
  makeApiKey                String?

  closeApiKey               String?

  logoUrl                   String?
  companySlogan             String?

  advisorIban               String?
  paymentSubject            String?
  creditorId                String?

  stripeSecretKey           String?
  stripePublishableKey      String?

  sevdeskApiToken           String?
  sevdeskApiUrl             String?

  company                   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model PipelinePhase {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  name        String
  slug        String   @unique
  order       Int      @default(0)
  color       String?
  isActive    Boolean  @default(true)
  type        String   @default("opportunity")
  description String?
  probability Int?
  status      String?
  isDefault   Boolean  @default(false)
  isConverted Boolean  @default(false)

  opportunities Opportunity[]
  leads         Lead[]
}

model Lead {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  firstName   String?
  lastName    String?
  email       String?
  phone       String?
  company     String?

  phaseId     String
  phase       PipelinePhase @relation(fields: [phaseId], references: [id])

  clientId    String?
  client      Client?  @relation(fields: [clientId], references: [id])

  source      String?
  notes       String?
  nextActionDate DateTime?
  nextActionNote String?

  automationData String?
}

model Opportunity {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  title       String
  description String?

  phaseId     String
  phase       PipelinePhase @relation(fields: [phaseId], references: [id])

  clientId    String?
  client      Client?  @relation(fields: [clientId], references: [id])

  firstName   String?
  lastName    String?
  email       String?
  phone       String?
  company     String?

  estimatedValue Float?
  probability    Int?
  nextActionDate DateTime?
  nextActionNote String?

  automationData String?

  airCallContactId String?
}

model RetirementConcept {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  clientId    String
  client      Client   @relation(fields: [clientId], references: [id])

  birthDate           DateTime?
  desiredRetirementAge Int?
  targetPensionNetto  Float?

  hasCurrentPensionInfo Boolean?
  pensionAtRetirement  Float?
  pensionIncrease       Float?

  inflationRate       Float?

  calculatedPensionAtRetirement Float?

  existingProvisionData String?
  totalExistingProvision Float?
  totalPensionWithProvision Float?
  calculatedTargetPension Float?

  lifeExpectancy       Int?
  monthlySavings       Float?
  returnRate           Float?
  withdrawalRate       Float?

  hasChildren          Boolean? @default(true)
  isCompulsoryInsured  Boolean? @default(true)
  kvBaseRate           Float?   @default(7.3)
  kvAdditionalRate     Float?   @default(2.5)
  kvContributionIncrease Float? @default(0)

  taxFilingStatus       String?  @default("single")
  taxFreeAmount         Float?   @default(12096)
  taxIncreaseRate       Float?   @default(0)
  taxFreePercentage     Float?   @default(83.5)
  capitalGainsTaxRate   Float?   @default(25)
  capitalGainsSoliRate  Float?   @default(5.5)
  capitalGainsChurchRate Float?  @default(0)
  capitalGainsAllowance Float?   @default(1000)
  calculationSnapshot   String?
  statutoryStrengths    String?
  statutoryWeaknesses   String?
  privateStrengths      String?
  privateWeaknesses     String?
  customTemplateHtml    String?
  recommendationDelta   Float?
  attachments           RetirementConceptAttachment[]

  notes               String?
}

model RetirementConceptAttachment {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  expiresAt    DateTime
  conceptId    String
  category     String
  filePath     String
  fileName     String
  originalName String
  mimeType     String
  size         Int

  concept RetirementConcept @relation(fields: [conceptId], references: [id], onDelete: Cascade)

  @@index([conceptId, category])
}

model ServiceContact {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name      String
  email     String?
  address   String?
  category  String?
  phone     String?
  notes     String?
}

model User {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  email             String   @unique
  passwordHash      String
  role              String
  name              String?
  isActive          Boolean  @default(true)
  resetToken        String?
  resetTokenExpires DateTime?
  visibleCategories String?
}
